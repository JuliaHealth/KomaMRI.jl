<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Diffusion-induced Signal Attenuation · KomaMRI.jl</title><meta name="title" content="Diffusion-induced Signal Attenuation · KomaMRI.jl"/><meta property="og:title" content="Diffusion-induced Signal Attenuation · KomaMRI.jl"/><meta property="twitter:title" content="Diffusion-induced Signal Attenuation · KomaMRI.jl"/><meta name="description" content="Documentation for KomaMRI.jl."/><meta property="og:description" content="Documentation for KomaMRI.jl."/><meta property="twitter:description" content="Documentation for KomaMRI.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/hide-documenter-example-output.css" rel="stylesheet" type="text/css"/><link href="../../assets/center-images.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.svg" alt="KomaMRI.jl logo"/><img class="docs-dark-only" src="../../assets/logo-dark.svg" alt="KomaMRI.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">🏠 Home</a></li><li><a class="tocitem" href="../../how-to/1-getting-started/">🏃 Getting Started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">🏋️ Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../01-FID/">Free Induction Decay</a></li><li><a class="tocitem" href="../02-SmallTipApproximation/">Small Tip Angle Approximation</a></li><li><a class="tocitem" href="../03-ChemicalShiftEPI/">Chemical Shift in an EPI sequence</a></li><li><a class="tocitem" href="../04-3DSliceSelective/">Slice-Selective Acquisition of 3D Phantom</a></li><li><a class="tocitem" href="../05-SimpleMotion/">Patient&#39;s Motion During Acquisition</a></li><li class="is-active"><a class="tocitem" href>Diffusion-induced Signal Attenuation</a></li><li><a class="tocitem" href="../07-RRVariability/">Cardiac Cine MRI with Arrhythmias</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">🧑‍🔬 Reproducible Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorial-pluto/01-gradient-echo-spin-echo/">Understanding basic MRI sequences</a></li><li><a class="tocitem" href="../../tutorial-pluto/02-low-field-cmra-optimization/">Low-Field CMRA Optimization</a></li><li><a class="tocitem" href="../../tutorial-pluto/03-low-field-boost-optimization/">Low-Field BOOST Optimization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">👨‍🍳 How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../how-to/2-1-use-koma-ui/">Use Koma&#39;s User Interface</a></li><li><a class="tocitem" href="../../how-to/2-2-use-koma-notebooks/">Use Koma in Notebooks</a></li><li><a class="tocitem" href="../../how-to/2-3-use-koma-scripts/">Use Koma in Julia Scripts</a></li><li><a class="tocitem" href="../../how-to/3-create-your-own-phantom/">Create Your Own Phantom</a></li><li><a class="tocitem" href="../../how-to/3-create-your-own-sequence/">Create Your Own Sequence</a></li><li><a class="tocitem" href="../../how-to/4-run-distributed-simulations/">Run Distributed Simulations</a></li><li><a class="tocitem" href="../../how-to/5-contribute-to-koma/">Contribute to Koma</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">🤔 Explanations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/1-phantom/">Phantom</a></li><li><a class="tocitem" href="../../explanation/2-motion/">Motion</a></li><li><a class="tocitem" href="../../explanation/3-phantom-format/">Phantom File Format</a></li><li><a class="tocitem" href="../../explanation/4-sequence/">Sequence</a></li><li><a class="tocitem" href="../../explanation/5-seq-events/">Sequence Events</a></li><li><a class="tocitem" href="../../explanation/6-simulation/">Simulation</a></li><li><a class="tocitem" href="../../explanation/7-gpu-explanation/">GPU Parallelization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">👨‍💻 Reference Guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reference/1-api/">API Overview</a></li><li><a class="tocitem" href="../../reference/2-koma-base/">KomaMRIBase</a></li><li><a class="tocitem" href="../../reference/3-koma-core/">KomaMRICore</a></li><li><a class="tocitem" href="../../reference/4-koma-files/">KomaMRIFiles</a></li><li><a class="tocitem" href="../../reference/5-koma-plots/">KomaMRIPlots</a></li><li><a class="tocitem" href="../../reference/6-koma-mri/">KomaMRI</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">🏋️ Tutorials</a></li><li class="is-active"><a href>Diffusion-induced Signal Attenuation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Diffusion-induced Signal Attenuation</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaHealth/KomaMRI.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaHealth/KomaMRI.jl/blob/master/docs/src/tutorial/lit-06-DiffusionMotion.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Diffusion-induced-Signal-Attenuation"><a class="docs-heading-anchor" href="#Diffusion-induced-Signal-Attenuation">Diffusion-induced Signal Attenuation</a><a id="Diffusion-induced-Signal-Attenuation-1"></a><a class="docs-heading-anchor-permalink" href="#Diffusion-induced-Signal-Attenuation" title="Permalink"></a></h1><p><a href="../06-DiffusionMotion.jl"><img src="https://img.shields.io/badge/julia-script-9558B2?logo=julia" alt/></a> <a href="../06-DiffusionMotion.ipynb"><img src="https://img.shields.io/badge/jupyter-notebook-blue?logo=jupyter" alt/></a> <a href="https://mybinder.org/v2/gh/JuliaHealth/KomaMRI.jl/master?urlpath=git-pull%3Frepo%3Dhttps%253A%252F%252Fgithub.com%252FJuliaHealth%252FKomaMRI.jl%26urlpath%3Dlab%252Ftree%252FKomaMRI.jl%252Fdev%252Ftutorial%252F06-DiffusionMotion.ipynb%26branch%3Dgh-pages"><img src="https://mybinder.org/badge_logo.svg" alt/></a></p><p>The purpose of this tutorial is to showcase the simulation of diffusion-related effects. For this, we are going to define a <a href="../../reference/2-koma-base/#KomaMRIBase.Path"><code>Path</code></a> motion to simulate the Brownian motion of spins. This is not the most efficient way of simulating diffusion, but it is a good way to understand the phenomenon. In particular, we will going to simulate isotropic diffusion, characterized by the Apparent Diffusion Coefficient (ADC).</p><h3 id="Creating-a-phantom-with-isotropic-diffusion"><a class="docs-heading-anchor" href="#Creating-a-phantom-with-isotropic-diffusion">Creating a phantom with isotropic diffusion</a><a id="Creating-a-phantom-with-isotropic-diffusion-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-phantom-with-isotropic-diffusion" title="Permalink"></a></h3><p>First we will define a <code>Phantom</code> without motion containing <span>$10,000$</span> spins. The spins will have the same relaxation times <span>$T_1 = 1000\,\mathrm{ms}$</span> and <span>$T_2 = 100\,\mathrm{ms}$</span>, and will be placed at the origin.</p><pre><code class="language-julia hljs">Nspins = 10_000
obj = Phantom(;
    x  = zeros(Nspins),
    T1 = ones(Nspins) * 1000e-3,
    T2 = ones(Nspins) * 100e-3,
);</code></pre><p>Now we will define the Brownian motion of the spins using the <a href="../../reference/2-koma-base/#KomaMRIBase.Path"><code>Path</code></a> motion definition. The motion will be defined by the displacements in the x, y, and z directions (<code>dx</code>, <code>dy</code>, and <code>dz</code>) of the spins. The displacements will be generated by a random walk with mean square displacement</p><p class="math-container">\[\mathbb{E}\left[x^{2}\right]=2D Δt,\]</p><p>where <span>$D$</span> is the diffusion coefficient and <span>$Δt$</span> is time step duration.</p><pre><code class="language-julia hljs">D = 2e-9                # Diffusion Coefficient of water in m^2/s
T = 100e-3              # Duration of the motion
Nt = 100                # Number of time steps
Δt = T / (Nt - 1)       # Time sep
Δr = sqrt(2 * D * Δt);  # √ Mean square displacement</code></pre><p>Random walk is defined as the cumulative sum of random displacements:</p><pre><code class="language-julia hljs">rng = MersenneTwister(1234) # Setting up the random seed
dx = cumsum([zeros(Nspins) Δr .* randn(rng, Nspins, Nt - 1)]; dims=2)
dy = cumsum([zeros(Nspins) Δr .* randn(rng, Nspins, Nt - 1)]; dims=2)
dz = cumsum([zeros(Nspins) Δr .* randn(rng, Nspins, Nt - 1)]; dims=2);</code></pre><p>Including the <code>random_walk</code> into the <code>Phantom</code> definition:</p><pre><code class="language-julia hljs">random_walk = Path(dx, dy, dz, TimeRange(0.0, T))
obj.motion = random_walk
p1 = plot_phantom_map(obj, :T1; time_samples=Nt÷4, height=450)</code></pre><center><object type="text/html" data="../../assets/6-displacements.html" style="width:85%; height:470px;"></object></center><p>The plot shows the random walk of spins due to diffusion, also known as Brownian motion. This motion was named after Robert Brown, who first described the phenomenon in 1827 while looking at pollen suspended in water under a microscope.</p><h3 id="Pulse-Gradient-Spin-Echo-(PGSE)-sequence"><a class="docs-heading-anchor" href="#Pulse-Gradient-Spin-Echo-(PGSE)-sequence">Pulse Gradient Spin Echo (PGSE) sequence</a><a id="Pulse-Gradient-Spin-Echo-(PGSE)-sequence-1"></a><a class="docs-heading-anchor-permalink" href="#Pulse-Gradient-Spin-Echo-(PGSE)-sequence" title="Permalink"></a></h3><p>The classical sequence used to measure diffusion is the pulse gradient spin echo (PGSE) introduced by Stejskal and Tanner in 1965. This sequence is characterized by the use of two diffusion gradients, placed right before and right after the inversion RF pulse. The duration of each gradient is defined by the δ parameter and the distance between the beginning of both gradients is described by the Δ parameter. In this tutorial square-shaped gradients will be used.</p><p>First, we generate the RF pulses:</p><pre><code class="language-julia hljs">sys   = Scanner()
durRF = 1e-3
B1    = (π / 2) / (2π * γ * durRF)
rf90  = PulseDesigner.RF_hard(B1, durRF, sys)
rf180 = (0.0 + 2im) * rf90;</code></pre><p>Now we generate the gradients:</p><pre><code class="language-julia hljs">G = 30e-3            # Gradient amplitude
δ = 30e-3            # Duration of the gradient
Δ = durRF + δ        # Time between the two gradients
gx_diff = Grad(G, δ);</code></pre><p>Finally, we generate the ADC:</p><pre><code class="language-julia hljs">adc_dwell_time = 1e-6
adc = ADC(1, adc_dwell_time, durRF/2 - adc_dwell_time/2); # ADCs with N=1 are positioned at the center</code></pre><p>Obtaining the PGSE sequence:</p><pre><code class="language-julia hljs">seq = Sequence()
seq += rf90
seq += gx_diff
seq += rf180
seq += gx_diff
seq += adc
p2 = plot_seq(seq; show_adc=true) # Plotting the sequence</code></pre><center><object type="text/html" data="../../assets/6-pgse_sequence.html" style="width:100%; height:300px;"></object></center><p>For the isotropic diffusion, the signal attenuation is given by the Stejskal-Tanner formula:</p><p class="math-container">\[E = \exp\left(-b D\right)\]</p><p>where (b) is the b-value, defined as:</p><p class="math-container">\[b = (\gamma G \delta)^{2} \cdot \left(\Delta - \delta/3\right)\]</p><p>where <span>$\gamma$</span> is the gyromagnetic ratio, <span>$G$</span> is the gradient amplitude, <span>$\delta$</span> is the gradient duration, and <span>$\Delta$</span> is the time between the two gradients.</p><pre><code class="language-julia hljs">function bvalue(seq)
    block, axis = 2, 1 # Gx from second block
    G = seq.GR[axis, block].A
    δ = seq.GR[axis, block].T
    Δ = dur(seq[2:3]) # Because there are no gaps
    b = (2π * γ * G * δ)^2 * (Δ - δ/3)
    return b * 1e-6
end;</code></pre><h3 id="Diffusion-Weighted-Imaging-(DWI)"><a class="docs-heading-anchor" href="#Diffusion-Weighted-Imaging-(DWI)">Diffusion Weighted Imaging (DWI)</a><a id="Diffusion-Weighted-Imaging-(DWI)-1"></a><a class="docs-heading-anchor-permalink" href="#Diffusion-Weighted-Imaging-(DWI)" title="Permalink"></a></h3><p>For DWI, multiple b-values are acquired to determine the tissue&#39;s ADC. For this, we will scale the gradient&#39;s amplitude of the previous sequence to obtain a desired b-value. We will store the sequences in a vector <code>seqs</code> and simulate the signal for each one of them.</p><pre><code class="language-julia hljs">seqs = Sequence[] # Vector of sequences
bvals = [0, 250, 500, 1000, 1500, 2000] # b-values in s/mm^2
for bval_target in bvals
    gradient_scaling = sqrt(bval_target / bvalue(seq))
    seq_b = gradient_scaling * seq
    push!(seqs, seq_b)
end</code></pre><p>To simulate, we will broadcast the <code>simulate</code> function over the sequences and store the signals in a vector <code>Sb</code>. The <code>Ref</code>&#39;s are used to avoid broadcasting the <code>obj</code> and <code>sys</code> arguments (they will remain constant for all <code>seqs</code>).</p><pre><code class="language-julia hljs">sim_params = KomaMRICore.default_sim_params()
sim_params[&quot;return_type&quot;] = &quot;mat&quot;
sim_params[&quot;Δt&quot;] = Δt; # Set max. grad. time step to fit diffusion time step

signals = @suppress simulate.(Ref(obj), seqs, Ref(sys); sim_params); # simulate broadcasted over seqs

Sb = [sb[1] for sb in signals] # Reshaping the simulated signals
bvals_si = bvals .* 1e6; # Convert b-values from s/mm^2 to s/m^2

E_simulated   = abs.(Sb) ./ abs.(Sb[1])
E_theoretical = exp.(-bvals_si .* D);</code></pre><center><object type="text/html" data="../../assets/6-pgse_signal_attenuation.html" style="width:80%; height:400px;"></object></center><p>The plot shows the signal attenuation as a function of the b-value. The simulated signal attenuation matches the theoretical curve, showing the expected exponential decay with the b-value.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../05-SimpleMotion/">« Patient&#39;s Motion During Acquisition</a><a class="docs-footer-nextpage" href="../07-RRVariability/">Cardiac Cine MRI with Arrhythmias »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 10 July 2025 22:44">Thursday 10 July 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
